## 分布式事务调研
### rocketmq
#### 简介
支持事务消息，采用预提交方案，把消息设计为二段提交，本地事务成功执行完毕，mq服务端才会改变消息的状态，下游服务消费方才真正可以接收到消息
#### 缺点
1. 自己设计事务回查的方案(风险)，因为二段提交时如果失败，需要mq服务端回查消息来确定事务是否执行成功(如果二段提交可以拿到mq服务端的处理回执，就可以把二段提交绑定到本地事务，这样就能保证二段提交和本地事务是同时完成，就可以忽略事务回查)
2. 下游服务假如自己真的失败了，没法通知调用方也回滚，需下游服务自己处理(例如回调调用方的服务，做对冲操作，或发送邮件人工干预)
3. 下游服务需要保证幂等，因网络问题可能发生重复消费，可以给消息增加唯一id的列
#### 解决的问题
1. 消息发送失败重复发送消息，保证调用方事务提交成功后，消息一定会到下游服务
### kafka
#### 简介
不支持事务消息
#### 方案设计1
采用本地事务，调用方新增消息表
1. 业务代码里绑定写消息到本地消息表，保证一致性，即写入消息表的数据在调用方也一定执行成功
2. job轮询本地消息表，把消息写入kafka，写入成功把本地消息表的消息状态改为成功推送(类似重试机制，失败下次job继续推消息)
3. 接收方收到消息，把消息落地到本地消息表
4. job轮询消息表处理事务数据
#### 缺点
1. 与业务紧耦合
2. 占用数据库资源
3. 同rocketmq第二条缺点
